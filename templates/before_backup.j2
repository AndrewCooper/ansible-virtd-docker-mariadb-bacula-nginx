#!/bin/bash
set -e

{% if bacula_director_backup_vms is defined %}
# *****************************************************************************
# Backup VMs

/usr/bin/virt-backup --action dump --vm={{ bacula_director_backup_vms }}
{% endif %}


{% if openssl_docker_backup_dir is defined %}
# *****************************************************************************
# Backup openssl data container

mkdir -p -m u=rwx,g=rwx,o= {{ openssl_docker_backup_dir }}
chown root:tape {{ openssl_docker_backup_dir }}
docker run --rm \
    --volumes-from {{ openssl_dv_name }} \
    {{ openssl_image_name }}:{{ docker_image_tag }} archive > \
        {{ openssl_docker_backup_dir }}{{ openssl_backup_file }}
{% endif %}


{% if openldap_docker_backup_dir is defined %}
# *****************************************************************************
# backup OpenLDAP data container

mkdir -p -m u=rwx,g=rwx,o= {{ openldap_docker_backup_dir }}
chown root:tape {{ openldap_docker_backup_dir }}
docker run --rm \
    --volumes-from {{ openldap_dv_name }} \
    -v {{ openldap_docker_backup_dir }}:/tmp/import_export \
    {{ openldap_image_name }}:{{ docker_image_tag }} backup
{% endif %}


{% if svn_docker_backup_dir is defined %}
# *****************************************************************************
# Backup SVN repositories

mkdir -p -m u=rwx,g=rwx,o= {{ svn_docker_backup_dir }}
chown root:tape {{ svn_docker_backup_dir }}
docker run --rm \
    --volumes-from {{ svn_dv_name }} \
    -v {{ svn_docker_backup_dir }}:/tmp/import_export \
    {{ svn_image_name }}:{{ docker_image_tag }} backup
{% endif %}


{% if wiki_docker_backup_dir is defined %}
# *****************************************************************************
# Backup WIKI data container

mkdir -p -m u=rwx,g=rwx,o= {{ wiki_docker_backup_dir }}
chown root:tape {{ wiki_docker_backup_dir }}
pushd {{ docker_restore_config_base_dir }}/{{ wiki_dv_name }}/wiki_DV
./mediawiki.sh backup
popd
{% endif %}


{% if gitlab_docker_backup_dir is defined %}
# *****************************************************************************
# Backup gitlab

mkdir -p -m u=rwx,g=rwx,o= {{ gitlab_docker_backup_dir }}
chown root:tape {{ gitlab_docker_backup_dir }}
pushd {{ docker_restore_config_base_dir }}/{{ gitlab_dv_name }}
./gitlab.sh backup
popd
{% endif %}
